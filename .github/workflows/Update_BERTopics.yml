name: Update BERT

on:
  workflow_dispatch:

  
permissions:
  contents: write
jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Pull latest articles
        run: git pull origin main --rebase

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install jq

      - name: Run script
        env: 
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY_NEWS }}
          GEMINI_API_KEY_X: ${{ secrets.GEMINI_API_KEY_X }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          COOKIE_HEADER: ${{ secrets.COOKIE_HEADER }}
          PAID_API_KEY: ${{ secrets.PAID_API_KEY }}
        run: |
          python Model_training/BERT_update.py

      - name: Commit and push results (excluding model)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add Model_training/BERTopic_results.csv
          git add Model_training/topics_BERT.json
          git commit -m "Update topic results from GitHub Actions run" || echo "No changes to commit"
          git pull --rebase origin main
          git push origin main

      - name: Upload BERTopic model to existing release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="rss_json"
          FILE_PATH="Model_training/BERTopic_model"
          FILE_NAME="BERTopic_model"

          echo "üîç Getting release ID for tag: $RELEASE_TAG"
          RELEASE_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/repos/ERSRisk/Tulane-Sentiment-Analysis/releases/tags/$RELEASE_TAG | jq -r '.id')

          echo "‚¨ÜÔ∏è Uploading $FILE_NAME to release ID $RELEASE_ID..."
          curl -s -X POST -H "Authorization: token $GH_TOKEN" \
               -H "Content-Type: application/octet-stream" \
               --data-binary @"$FILE_PATH" \
               "https://uploads.github.com/repos/ERSRisk/Tulane-Sentiment-Analysis/releases/$RELEASE_ID/assets?name=$FILE_NAME"
